# iptables -> Lobster Tool Design

## Goals

Given a file generated by the `iptables-save` executable, produce a
Lobster file that encodes those firewall rules.

In particular, we want to handle the SECMARK and CONNSECMARK
extensions to `iptables` that allow for packets to be marked with an
SELinux security context.

We also eventually want to meaningfully translate the matching
arguments of an `iptables` rule into a form that is semantically
meaningful in Lobster. This will support interpretation of those rules
by assertion checkers and other analysis tools.

## Non-Goals

`iptables` is part of the larger Netfilter infrastructure which also
includes filtering capabilities for ARP and bridging (`arptables` and
`ebtables`). Some of the filtering done by these complementary tools
is done between phases of `iptables` filtering, meaning that their
rules might interrupt the flow of a packet through `iptables`
rules.

For this stage of the V3SPA project, we are assuming that there is no
filtering done by any part of Netfilter *except* `iptables`, thus
letting packets unconditionally through any part of the filtering
structure not governed by `iptables`.

## Example cases

- `example.lsr` contains a simple `iptables` setup that whitelists
  particular IP addresses on particular ports, and blocks all other
  traffic.

- `ftp.lsr` is an example from a
  [blog post](http://james-morris.livejournal.com/11010.html)
  demonstrating the interaction between `iptables` and SELinux with
  SECMARK and CONNSECMARK. It adds a security context to any packets
  related to an ftp connection, so that they can participate in
  mandatory access control on the SELinux side.

## Technical Design

The implementation of this tool will proceed in two phases
distinguished by their treatment of the matching arguments to
`iptables` rules. In the first phase, these arguments will be largely
uninterpreted, instead passed along as literal strings to the
constructors of the corresponding Lobster domains. In the second
phase, we will interpret the syntax of matching rules into a
to-be-determined syntax used on the Lobster side.

### Phase One

The tool will produce output similar to the hand-written output in the
example cases. The matching arguments to rules will be left
uninterpreted, but the targets of rules will be interpreted in order
to produce correct port relationships.

Should a rule target include a SECMARK directive, we will produce an
edge to a stub domain corresponding to the target's SELinux security
context. This will likely then be grafted to a graph produced from
SELinux policy in order to produce a cohesive whole.
